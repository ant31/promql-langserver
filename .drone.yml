---
kind: pipeline
type: docker
name: buildandtest

workspace:
  base: /go
  path: src/github.com/slrtbtfs/promql-lsp

steps:
  - name: build
    image: golang:1.13
    commands:
      - go build cmd/
  - name: test
    image: golang:1.13
    commands:
      - go get ./cmd/...
      - make test

---
kind: pipeline
type: docker
name: check_repo_consistency

steps:
  - name: check_generated_files
    image: golang:1.13
    commands:
      - go get github.com/rakyll/statik
      - make clean
      - make generated
      - bash -c "[[ `(git diff ; git add -fAn) | wc -l` -eq 0 ]] || ( git --no-pager diff; git add -fAn; echo Please run 'make generated' and commit again ; exit 1 )"
  - name: check_gofmt
    image: golang:1.13
    commands:
      - make fmt
      - bash -c "[[ `(git diff ; git add -fAn) | wc -l` -eq 0 ]] || ( git --no-pager diff; git add -fAn; echo Please run 'make fmt' and commit again ; exit 1 )"
  - name: check_vendored_files
    image: golang:1.13
    commands:
      - make update_internal_packages
      - bash -c "[[ `(git diff ; git add -fAn) | wc -l` -eq 0 ]] || ( git --no-pager diff; git add -fAn; echo Please run 'make update_internal_packages' and commit again ; exit 1 )"

---
kind: pipeline
type: docker
name: lint

workspace:
  base: /go
  path: src/github.com/slrtbtfs/promql-lsp

steps:
  - name: lint
    image: golangci/golangci-lint
    commands:
      - go get ./cmd/...
      - make lint